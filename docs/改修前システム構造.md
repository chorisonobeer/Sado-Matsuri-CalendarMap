# 改修前システム構造分析書

## 1. システム概要

### アプリケーション名
**NIIGATA CRAFT BEER MAP2025** - 新潟のクラフトビールが飲める・買える・楽しめるPWAマップ

### 技術スタック
- **フロントエンド**: React 17.0.2 + TypeScript 4.6.2
- **ルーティング**: React Router DOM 6.2.2
- **スタイリング**: SCSS + Emotion (CSS-in-JS)
- **地図**: Geolonia Maps API
- **データ取得**: Papa Parse (CSV解析)
- **PWA**: Service Worker + Manifest
- **ビルドツール**: React Scripts 5.0.1

## 2. アーキテクチャ構造

### 2.1 ディレクトリ構造
```
src/
├── App.tsx                    # メインアプリケーションコンポーネント
├── App.scss                   # アプリケーション全体のスタイル
├── Container.tsx              # コンテナコンポーネント
├── config.json               # アプリケーション設定
├── types.d.ts                # TypeScript型定義
├── App/                      # 各ページコンポーネント
│   ├── Home.tsx              # ホーム画面（地図+検索）
│   ├── List.tsx              # 一覧表示
│   ├── Category.tsx          # カテゴリ別表示
│   ├── Images.tsx            # 画像から探す
│   ├── Events.tsx            # イベント情報（新規追加済み）
│   ├── AboutUs.tsx           # アプリについて
│   ├── Tabbar.tsx            # 下部タブナビゲーション
│   ├── LazyMap.tsx           # 地図コンポーネント（遅延読み込み）
│   ├── Map.tsx               # 地図本体
│   ├── Shop.tsx              # 店舗詳細モーダル
│   ├── SearchFeature.tsx     # 検索機能
│   └── その他コンポーネント
├── context/
│   └── GeolocationContext.tsx # 位置情報コンテキスト
└── lib/
    ├── table2json.ts         # テーブル→JSON変換
    └── zen2han.ts            # 全角半角変換
```

### 2.2 データフロー

#### 主要データソース
1. **店舗データ**: Googleスプレッドシート（CSV形式）
   - URL: `config.json` の `data_url`
   - 形式: Papa Parse でCSV解析
   - キャッシュ: sessionStorage

2. **イベントデータ**: 別のGoogleスプレッドシート（CSV形式）
   - URL: `config.json` の `event_data_url`
   - 形式: 同様にCSV解析
   - キャッシュ: sessionStorage

#### データフロー図
```
Googleスプレッドシート
        ↓ (CSV)
    Papa Parse
        ↓ (JSON)
   sessionStorage
        ↓
   App.tsx (State)
        ↓
各コンポーネント (Props)
```

## 3. コンポーネント構造

### 3.1 メインコンポーネント (App.tsx)
**責務**: 
- データ取得・管理
- ルーティング制御
- 全体状態管理

**主要State**:
```typescript
const [shopList, setShopList] = useState<Pwamap.ShopData[]>([]);
const [selectedShop, setSelectedShop] = useState<Pwamap.ShopData | undefined>();
const [filteredShops, setFilteredShops] = useState<Pwamap.ShopData[]>([]);
const [error, setError] = useState<string>("");
```

**データ取得ロジック**:
1. sessionStorageキャッシュチェック
2. キャッシュ有り → 即座に表示 + バックグラウンド更新
3. キャッシュ無し → 通常取得

### 3.2 ルーティング構造
```typescript
<Routes>
  <Route path="/" element={<Home />} />
  <Route path="/list" element={<List />} />
  <Route path="/category" element={<Category />} />
  <Route path="/images" element={<Images />} />
  <Route path="/about" element={<AboutUs />} />
  <Route path="/events" element={<Events />} />
</Routes>
```

### 3.3 ナビゲーション (Tabbar.tsx)
**タブ構成**:
- ホーム (地図)
- 一覧
- 写真から探す
- イベント
- マップについて

## 4. データ構造

### 4.1 店舗データ型 (ShopData)
```typescript
type ShopData = {
  index: number;
  タイムスタンプ?: string;
  スポット名: string;
  緯度: string;
  経度: string;
  [key: string]: any; // その他の動的フィールド
}
```

### 4.2 イベントデータ型 (EventData)
```typescript
type EventData = {
  index: number;
  タイムスタンプ?: string;
  イベント名: string;
  開催期間: string;
  開始時間: string;
  終了時間: string;
  場所: string;
  説明文: string;
  画像URL1-6?: string;
  主催者名: string;
  タグ?: string;
  緯度?: string;
  経度?: string;
  公式サイト?: string;
  Instagram?: string;
  Facebook?: string;
  Twitter?: string;
  X?: string;
}
```

## 5. 地図機能

### 5.1 地図ライブラリ
- **Geolonia Maps**: 日本向けに最適化された地図サービス
- **クラスター機能**: 近接マーカーの自動グループ化
- **レスポンシブ対応**: モバイルファースト設計

### 5.2 地図コンポーネント構造
```
LazyMap.tsx (遅延読み込みWrapper)
    ↓
Map.tsx (地図本体)
    ↓
Geolonia Maps API
```

### 5.3 マーカー表示ロジック
1. データをGeoJSON形式に変換
2. クラスター設定適用
3. マーカークリック → 詳細モーダル表示

## 6. 検索・フィルター機能

### 6.1 SearchFeature.tsx
**機能**:
- キーワード検索
- カテゴリフィルター
- 位置情報ベース検索

**検索対象フィールド**:
- スポット名
- 住所
- タグ
- 説明文

## 7. PWA機能

### 7.1 Service Worker
- **キャッシュ戦略**: Cache First
- **オフライン対応**: 基本的なページ表示
- **更新通知**: バージョンチェック機能

### 7.2 Manifest設定
```json
{
  "name": "NIIGATA CRAFT BEER MAP2025",
  "short_name": "NIIGATA BEER MAP",
  "display": "standalone",
  "orientation": "portrait"
}
```

## 8. スタイリング

### 8.1 デザインシステム
- **プライマリーカラー**: #00A0E6 (青)
- **フォント**: BIZ UDPGothic
- **レイアウト**: モバイルファースト
- **UI要素**: Material-UI ベース

### 8.2 レスポンシブ対応
- **ブレークポイント**: 768px
- **単位**: vw/vh (ビューポート相対)
- **フォントサイズ**: clamp() 関数使用

## 9. パフォーマンス最適化

### 9.1 コード分割
- **React.lazy()**: 地図コンポーネント
- **動的インポート**: 重いライブラリ

### 9.2 データキャッシュ
- **sessionStorage**: CSV データ
- **メモ化**: React.memo, useMemo, useCallback

### 9.3 画像最適化
- **遅延読み込み**: Intersection Observer
- **WebP対応**: 自動フォーマット選択

## 10. 現在の課題・制限事項

### 10.1 データ管理
- **単一データソース**: 店舗情報のみ（イベントは別途追加済み）
- **リアルタイム更新**: 手動更新のみ
- **データ検証**: 最小限のバリデーション

### 10.2 UI/UX
- **カレンダー機能**: 未実装
- **フィルター**: 基本的な検索のみ
- **ソート機能**: タイムスタンプ順のみ

### 10.3 機能制限
- **ユーザー投稿**: 未対応
- **お気に入り**: 未実装
- **通知機能**: 未実装

## 11. 技術的負債

### 11.1 型安全性
- **any型の使用**: 地図ライブラリ周り
- **動的プロパティ**: [key: string]: any

### 11.2 コンポーネント設計
- **責務の分離**: 一部のコンポーネントが肥大化
- **状態管理**: Props drilling の発生

### 11.3 テスト
- **テストカバレッジ**: 最小限
- **E2Eテスト**: 未実装

---

**分析日**: 2025年1月20日  
**分析者**: システム構造解析AI  
**対象バージョン**: 1.0.0